---
pipeline:

  synch_dev_secrets:
    image: quay.io/ukhomeofficedigital/cop-secrets
    environment:
      - DRONE_SERVER=https://drone.acp.homeoffice.gov.uk
      - DEPLOY_ENV=dev
    secrets:
      - source: DEV_DRONE_AWS_ACCESS_KEY_ID
        target: AWS_ACCESS_KEY_ID
      - source: DEV_DRONE_AWS_SECRET_ACCESS_KEY
        target: AWS_SECRET_ACCESS_KEY
      - source: DRONE_PUBLIC_TOKEN
        target: DRONE_TOKEN
    when:
      environment: secrets
      event: deployment

  deploy_to_dev:
    image: quay.io/ukhomeofficedigital/kd
    secrets:
      - source: DEV_POSTGREST_NAME
        target: POSTGREST_NAME
      - source: DEV_POSTGREST_IMAGE
        target: POSTGREST_IMAGE
      - source: DEV_POSTGREST_TAG
        target: POSTGREST_TAG
      - source: NGINX_IMAGE
        target: NGINX_IMAGE
      - source: NGINX_TAG
        target: NGINX_TAG
      - source: DB_REF_REFERENCE_SCHEMA
        target: DB_REF_REFERENCE_SCHEMA
      - source: DB_REF_REFERENCE_ANON_USERNAME
        target: DB_REF_REFERENCE_ANON_USERNAME
      - source: DEV_POSTGREST_URI
        target: POSTGREST_URI
      - source: DEV_POSTGREST_URL
        target: POSTGREST_URL
      - source: DEV_POSTGREST_AUD
        target: POSTGREST_AUD
      - source: DEV_POSTGREST_ROLE_CLAIM_KEY
        target: POSTGREST_ROLE_CLAIM_KEY
      - source: DEV_KEYCLOAK_JWT
        target: KEYCLOAK_JWT
      - source: DEV_KUBE_SERVER
        target: KUBE_SERVER
      - source: DEV_KUBE_TOKEN
        target: KUBE_TOKEN
      - source: DEV_KUBE_NAMESPACE_PRIVATE_COP
        target: KUBE_NAMESPACE
    commands:
      - kd --insecure-skip-tls-verify -f kube/cert.yml
      - kd --insecure-skip-tls-verify -f kube/secret.yml
      - kd --insecure-skip-tls-verify -f kube/network-policy.yml
      - kd --insecure-skip-tls-verify -f kube/service.yml
      - kd --insecure-skip-tls-verify -f kube/deployment.yml
      - kd --insecure-skip-tls-verify -f kube/ingress.yml
    when:
      event: push
      branch: master
